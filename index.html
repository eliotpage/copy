<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Offline Mesh Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-sA+1YtElg0r4vyPFr3tQ8/6zQ7+kZ9kH98zOgZPQ0MI="
          crossorigin=""/>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

    <style>
        body, html { margin: 0; height: 100%; }
        #map { width: 100%; height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-VtR1g7Xn8+RljDqOHJmN1u+uAq3zIhK8v+4gQ5s8E8E="
        crossorigin=""></script>

<!-- Leaflet Draw JS -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    console.log("[Client] Initializing map");

    const map = L.map('map', {center: [51.505, -0.09], zoom: 13});
    const tileLayer = L.tileLayer('/tiles/{z}/{x}/{y}.png', {maxZoom: 19, minZoom: 0, attribution: "Offline Tiles"}).addTo(map);

    const annotationsLayer = L.layerGroup().addTo(map);
    const obstaclesLayer = L.layerGroup().addTo(map);
    const pathLayer = L.layerGroup().addTo(map);

    const drawControl = new L.Control.Draw({
        draw: {marker: true, circle: {shapeOptions: { color: 'red', weight: 2 }}, polygon: false, polyline: false, rectangle: false},
        edit: { featureGroup: annotationsLayer }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        if (layer instanceof L.Marker) {
            const latlng = layer.getLatLng();
            console.log("[Client] Marker created at", latlng);
            fetch('/api/add_annotation', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lat: latlng.lat, lon: latlng.lng, data: 'User annotation'})
            }).then(() => annotationsLayer.addLayer(layer))
            .catch(err => console.error("[Client] Error adding annotation:", err));
        }
        if (layer instanceof L.Circle) {
            const latlng = layer.getLatLng();
            const radius = layer.getRadius();
            console.log("[Client] Circle created at", latlng, "radius", radius);
            fetch('/api/add_obstacle', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lat: latlng.lat, lon: latlng.lng, radius: radius, data: 'User obstacle'})
            }).then(() => obstaclesLayer.addLayer(layer))
            .catch(err => console.error("[Client] Error adding obstacle:", err));
        }
    });

    async function updateLayers() {
        try {
            const annResp = await fetch('/api/get_annotations');
            const annotations = await annResp.json();
            annotationsLayer.clearLayers();
            annotations.forEach(a => annotationsLayer.addLayer(L.marker([a.lat, a.lon]).bindPopup(a.data)));
            console.log(`[Client] Loaded ${annotations.length} annotations`);

            const obsResp = await fetch('/api/get_obstacles');
            const obstacles = await obsResp.json();
            obstaclesLayer.clearLayers();
            obstacles.forEach(o => obstaclesLayer.addLayer(L.circle([o.lat, o.lon], {radius: o.radius, color: 'red', weight: 2}).bindPopup(o.data)));
            console.log(`[Client] Loaded ${obstacles.length} obstacles`);
        } catch (err) { console.error("[Client] Error updating layers:", err); }

        setTimeout(updateLayers, 2000);
    }
    updateLayers();

    async function updatePath(start, goal) {
        try {
            const resp = await fetch('/api/get_path', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({start: start, goal: goal})});
            const data = await resp.json();
            pathLayer.clearLayers();
            if (data.status === 'ok') {
                const latlngs = data.path.map(p => [p[0], p[1]]);
                pathLayer.addLayer(L.polyline(latlngs, {color: 'blue', weight: 3}));
                console.log(`[Client] Path drawn with ${latlngs.length} points`);
            } else {
                console.warn("[Client] Path API returned error:", data.message);
            }
        } catch (err) { console.error("[Client] Error fetching path:", err); }
    }

    updatePath([51.505, -0.09], [51.51, -0.1]);
</script>
</body>
</html>
